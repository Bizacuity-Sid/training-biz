name: Oracle SQL Validation

on:
  push:
    branches:
      - main

jobs:
  validate-sql:
    runs-on: ubuntu-latest

    env:
      ORACLE_CONN_STR: ${{ secrets.ORACLE_CONN_STR }}

    steps:
    - name: 🛎️ Checkout repository
      uses: actions/checkout@v3

    - name: 🔧 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: 📦 Install dependencies
      run: pip install oracledb

    - name: 🧪 Run tests and SQL guideline checks
      shell: bash
      run: |
        mkdir -p results
        mkdir -p reports
        echo "🔎 Oracle SQL Validation Report" > reports/report.txt
        echo "Generated: $(date)" >> reports/report.txt
        echo "" >> reports/report.txt

        failed=0

        for file in queries/*.sql; do
          base=$(basename "$file" .sql)
          echo "🔄 Processing $base..."

          echo "▶️ Running student query..."
          if ! python oracle-runner.py "queries/$base.sql" "results/${base}_user.out" "$ORACLE_CONN_STR"; then
            echo "❌ Error executing student query: $base.sql" >> reports/report.txt
            failed=1
            continue
          fi

          echo "▶️ Running solution query..."
          if ! python oracle-runner.py "solutions/$base.sql" "results/${base}_solution.out" "$ORACLE_CONN_STR"; then
            echo "❌ Error executing solution query: $base.sql" >> reports/report.txt
            failed=1
            continue
          fi

          echo "🔍 Comparing outputs..."
          if diff -q "results/${base}_user.out" "results/${base}_solution.out" > /dev/null; then
            echo "✅ Output match for $base" >> reports/report.txt
          else
            echo "❌ Output mismatch for $base" >> reports/report.txt
            echo "---- Diff ----" >> reports/report.txt
            diff "results/${base}_user.out" "results/${base}_solution.out" >> reports/report.txt || true
            echo "--------------" >> reports/report.txt
            failed=1
          fi

          echo "🧪 Running SQL guideline checker..."
          echo "📝 Guidelines for $base.sql:" >> reports/report.txt
          python sql_guideline_checker.py "queries/$base.sql" >> reports/report.txt
          echo "" >> reports/report.txt
        done

        echo "📄 Validation complete. See report.txt for details."

        # Final exit based on whether any test failed
        exit $failed

    - name: 📤 Upload full report
      uses: actions/upload-artifact@v4
      with:
        name: sql-validation-report
        path: reports/report.txt
