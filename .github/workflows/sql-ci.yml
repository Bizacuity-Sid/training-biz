name: Oracle SQL Validation

on:
  push:
    branches:
      - main

jobs:
  validate-sql:
    runs-on: ubuntu-latest

    env:
      ORACLE_CONN_STR: ${{ secrets.ORACLE_CONN_STR }}

    steps:
    - name: ðŸ›Žï¸ Checkout repository
      uses: actions/checkout@v3

    - name: ðŸ”§ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ðŸ“¦ Install dependencies
      run: pip install oracledb

    - name: ðŸ§ª Run tests and SQL guideline checks
      shell: bash
      run: |
        mkdir -p results
        mkdir -p reports
        echo "ðŸ”Ž Oracle SQL Validation Report" > reports/report.txt
        echo "Generated: $(date)" >> reports/report.txt
        echo "" >> reports/report.txt

        failed=0

        for file in queries/*.sql; do
          base=$(basename "$file" .sql)
          echo "ðŸ”„ Processing $base..."

          echo "â–¶ï¸ Running student query..."
          if ! python oracle-runner.py "queries/$base.sql" "results/${base}_user.out" "$ORACLE_CONN_STR"; then
            echo "âŒ Error executing student query: $base.sql" >> reports/report.txt
            failed=1
            continue
          fi

          echo "â–¶ï¸ Running solution query..."
          if ! python oracle-runner.py "solutions/$base.sql" "results/${base}_solution.out" "$ORACLE_CONN_STR"; then
            echo "âŒ Error executing solution query: $base.sql" >> reports/report.txt
            failed=1
            continue
          fi

          echo "ðŸ” Comparing outputs..."
          if diff -q "results/${base}_user.out" "results/${base}_solution.out" > /dev/null; then
            echo "âœ… Output match for $base" >> reports/report.txt
          else
            echo "âŒ Output mismatch for $base" >> reports/report.txt
            echo "---- Diff ----" >> reports/report.txt
            diff "results/${base}_user.out" "results/${base}_solution.out" >> reports/report.txt || true
            echo "--------------" >> reports/report.txt
            failed=1
          fi

          echo "ðŸ§ª Running SQL guideline checker..."
          echo "ðŸ“ Guidelines for $base.sql:" >> reports/report.txt
          python sql_guideline_checker.py "queries/$base.sql" >> reports/report.txt
          echo "" >> reports/report.txt
        done

        echo "ðŸ“„ Validation complete. See report.txt for details."

        # Final exit based on whether any test failed
        exit $failed

    - name: ðŸ“¤ Upload full report
      uses: actions/upload-artifact@v4
      with:
        name: sql-validation-report
        path: reports/report.txt
