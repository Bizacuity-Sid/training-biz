name: Oracle SQL Validation

on:
  push:
    branches:
      - main

jobs:
  validate-sql:
    runs-on: ubuntu-latest

    env:
      ORACLE_CONN_STR: ${{ secrets.ORACLE_CONN_STR }}

    steps:
    - name: ðŸ›Žï¸ Checkout repository
      uses: actions/checkout@v3

    - name: ðŸ”§ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ðŸ“¦ Install dependencies
      run: pip install oracledb

    - name: ðŸ§ª Run SQL tests and checks
      run: |
        mkdir -p results reports
        report_file="reports/report.txt"
        echo "ðŸ”Ž Oracle SQL Validation Report" > "$report_file"
        echo "Generated: $(date)" >> "$report_file"
        echo "" >> "$report_file"

        failed=0

        for file in queries/*.sql; do
          base=$(basename "$file" .sql)
          echo "::group::ðŸ” Validating $base.sql"

          user_output="results/${base}_user.out"
          solution_output="results/${base}_solution.out"

          echo "â–¶ï¸ Running student query: $file"
          if ! python oracle-runner.py "$file" "$user_output" "$ORACLE_CONN_STR"; then
            echo "âŒ Error executing student query: $base.sql" >> "$report_file"
            failed=1
            echo "::endgroup::"
            continue
          fi

          solution_file="solutions/$base.sql"
          echo "â–¶ï¸ Running solution query: $solution_file"
          if ! python oracle-runner.py "$solution_file" "$solution_output" "$ORACLE_CONN_STR"; then
            echo "âŒ Error executing solution query: $base.sql" >> "$report_file"
            failed=1
            echo "::endgroup::"
            continue
          fi

          echo "ðŸ” Comparing outputs..."
          if diff -q "$user_output" "$solution_output" > /dev/null; then
            echo "âœ… Output match for $base" >> "$report_file"
          else
            echo "âŒ Output mismatch for $base" >> "$report_file"
            echo "---- Diff ----" >> "$report_file"
            diff "$user_output" "$solution_output" >> "$report_file" || true
            echo "--------------" >> "$report_file"
            failed=1
          fi

          echo "ðŸ§ª Checking SQL guidelines..."
          echo "ðŸ“ Guidelines for $base.sql:" >> "$report_file"
          python sql_guideline_checker.py "$file" >> "$report_file"
          echo "" >> "$report_file"

          echo "::endgroup::"
        done

        echo "ðŸ“„ Validation complete. See full report in report.txt"
        exit $failed

    - name: ðŸ“¤ Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: sql-validation-report
        path: reports/report.txt

    - name: ðŸ“¤ Upload individual query results
      uses: actions/upload-artifact@v4
      with:
        name: sql-validation-results
        path: results/
